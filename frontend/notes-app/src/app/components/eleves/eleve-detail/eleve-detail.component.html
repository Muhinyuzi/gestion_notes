<div class="eleve-detail-container" *ngIf="!isLoading && eleve; else loadingTpl">

  <h2>D√©tails de l‚Äô√©l√®ve</h2>

  <!-- üßç Carte d'identit√© -->
  <div class="eleve-card">
    <div class="info">
      <h3>{{ eleve.prenom }} {{ eleve.nom }}</h3>

      <p><strong>Adresse :</strong> {{ eleve.adresse || 'Non sp√©cifi√©e' }}</p>

      <p><strong>Actif :</strong>
        <span class="status" [ngClass]="eleve.actif ? 'oui' : 'non'">
          {{ eleve.actif ? 'Oui' : 'Non' }}
        </span>
      </p>

      <p><strong>En attente :</strong> {{ eleve.en_attente ? 'Oui' : 'Non' }}</p>
    </div>

    <div class="actions">
      <button class="btn edit" (click)="editEleve()">‚úèÔ∏è Modifier</button>
      <button class="btn delete" (click)="deleteEleve()">üóëÔ∏è Supprimer</button>
    </div>
  </div>

  <!-- üìò Note assign√©e -->
  <div class="note-section">
    <h3>Note assign√©e</h3>

    <div *ngIf="note; else noNoteTpl" class="note-card">
      <h4>{{ note.titre }}</h4>
      <p>{{ note.contenu }}</p>

      <div class="note-actions">
        <button class="btn unassign" (click)="openDeassignModal(eleve)">‚ùå D√©sassigner</button>
      </div>
    </div>

    <ng-template #noNoteTpl>
      <p>Aucune note assign√©e.</p>
      <button class="btn assign" (click)="openAssignModal(eleve)">‚ûï Assigner une note</button>
    </ng-template>
  </div>

  <!-- üïì Historique -->
  <div class="history-section">
    <h3>Historique</h3>

    <div *ngIf="loadingHistory" class="loading">Chargement...</div>
    <div *ngIf="!loadingHistory && history.length === 0">
      Aucun historique disponible.
    </div>

    <div *ngIf="!loadingHistory && history.length > 0" class="history-list">
      <div *ngFor="let h of history" class="history-item">

        <div class="history-header">
          <span class="history-date">{{ h.edited_at | date:'short' }}</span>
          <span class="history-user">Par {{ getUserName(h.edited_by) }}</span>
        </div>

        <div class="history-changes">
          <ul>
            <li *ngFor="let key of getChangeKeys(h.changes)">
  <ng-container *ngIf="h.changes && h.changes[key]">
    <strong>{{ key }} :</strong>
    "{{ h.changes[key]?.old ?? '‚Äî' }}" ‚Üí "{{ h.changes[key]?.new ?? '‚Äî' }}"
  </ng-container>
</li>
          </ul>
        </div>

        <div class="history-reason">
          <em>Raison : {{ h.raison_changement }}</em>
        </div>

      </div>
    </div>

    <div *ngIf="errorHistory" class="error">{{ errorHistory }}</div>
  </div>
</div>

<!-- ============================== -->
<!-- ‚úÖ MODALE (PLAC√âE EN DEHORS DU CONTAINER) -->
<div class="modal-overlay" *ngIf="showNoteModal">
  <div class="modal">

    <h3 *ngIf="modalMode==='assign'">
      Assigner une note √† {{ modalEleve?.prenom }} {{ modalEleve?.nom }}
    </h3>

    <h3 *ngIf="modalMode==='deassign'">
      Retirer la note de {{ modalEleve?.prenom }} {{ modalEleve?.nom }}
    </h3>

    <!-- S√©lection de note -->
    <div *ngIf="modalMode==='assign'">
      <label>Choisir une note :</label>
      <select [(ngModel)]="selectedNoteId" class="form-select">
        <option [ngValue]="null" disabled selected>
          -- S√©lectionner une note --
        </option>
        <option *ngFor="let note of notes" [ngValue]="note.id">
          {{ note.titre }}
        </option>
      </select>
    </div>

    <!-- Affichage quand on retire -->
    <p *ngIf="modalMode==='deassign'">
      Note actuelle :
      <strong>{{ selectedNoteTitle }}</strong>
    </p>

    <!-- Boutons -->
    <div class="modal-actions">
      <button class="btn btn-primary" (click)="confirmNoteAction()">
        {{ modalMode==='assign' ? 'Assigner' : 'Retirer' }}
      </button>

      <button class="btn btn-secondary" (click)="closeNoteModal()">
        Annuler
      </button>
    </div>

  </div>
</div>

<!-- Loader -->
<ng-template #loadingTpl>
  <div class="loading">Chargement en cours...</div>
</ng-template>

<div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>
