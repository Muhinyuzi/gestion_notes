<div class="eleve-detail-container" *ngIf="!isLoading && eleve; else loadingTpl">

  <!-- ğŸ”™ Retour -->
  <button class="btn-back" (click)="goBack()">â† Retour</button>

  <h2>ğŸ‘¤ DÃ©tails de lâ€™Ã©lÃ¨ve</h2>

  <!-- Card Ã‰lÃ¨ve -->
  <div class="eleve-card">
    <div class="info">
      <h3>{{ eleve.prenom }} {{ eleve.nom }}</h3>

      <p><strong>Adresse :</strong> {{ eleve.adresse || 'Non spÃ©cifiÃ©e' }}</p>

      <p><strong>Statut :</strong>
        <span class="status-badge" [ngClass]="eleve.actif ? 'oui' : 'non'">
          {{ eleve.actif ? 'ğŸŸ¢ Actif' : 'ğŸ”´ Inactif' }}
        </span>
      </p>

      <p><strong>Ã‰tat :</strong>
        <span *ngIf="eleve.en_attente" class="status-badge wait">â³ En attente</span>
        <span *ngIf="!eleve.en_attente">âœ”ï¸ ConfirmÃ©</span>
      </p>
    </div>

    <div class="actions">
      <button class="btn edit" (click)="editEleve()">âœï¸ Modifier</button>
      <button class="btn delete" (click)="deleteEleve()">ğŸ—‘ï¸ Supprimer</button>
    </div>
  </div>

  <!-- ğŸ“˜ Note assignÃ©e -->
  <div class="note-section">
    <h3>ğŸ“ Note assignÃ©e</h3>

    <ng-container *ngIf="note; else noNoteTpl">
      <div class="note-card">
        <h4>{{ note.titre }}</h4>
        <p>{{ note.contenu }}</p>

        <div class="note-actions">
          <button class="btn cancel" (click)="openDeassignModal(eleve)">âŒ DÃ©sassigner</button>
        </div>
      </div>
    </ng-container>

    <ng-template #noNoteTpl>
      <p>Aucune note associÃ©e.</p>
      <button class="btn assign" (click)="openAssignModal(eleve)">â• Assigner une note</button>
    </ng-template>
  </div>

  <!-- ğŸ•“ Historique -->
  <div class="history-section">
    <h3>ğŸ“œ Historique des modifications</h3>

    <div *ngIf="loadingHistory">Chargement...</div>
    <div *ngIf="!loadingHistory && history.length === 0">Aucun historique.</div>

    <div *ngIf="!loadingHistory && history.length > 0" class="history-list">
      <div *ngFor="let h of history" class="history-item">

        <div class="history-header">
          <span>{{ h.edited_at | date:'short' }}</span> â€” 
          <span class="history-user">Par {{ getUserName(h.edited_by) }}</span>
        </div>

        <div class="history-changes">
          <ul>
            <li *ngFor="let key of getChangeKeys(h.changes)">
              <ng-container *ngIf="h.changes && h.changes[key]">
                <strong>{{ key }} :</strong>
                "{{ h.changes[key]?.old ?? 'â€”' }}" â†’ "{{ h.changes[key]?.new ?? 'â€”' }}"
              </ng-container>
            </li>
          </ul>
        </div>

        <div class="history-reason">
          <em>{{ h.raison_changement }}</em>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Modal Note -->
<div class="modal-overlay" *ngIf="showNoteModal">
  <div class="modal">

    <h3 *ngIf="modalMode==='assign'">Assigner une note</h3>
    <h3 *ngIf="modalMode==='deassign'">Retirer la note</h3>

    <!-- SÃ©lection de note -->
    <div *ngIf="modalMode==='assign'">
      <label>Choisir une note :</label>
      <select [(ngModel)]="selectedNoteId" class="form-select">
        <option [ngValue]="null" disabled selected> -- SÃ©lectionner -- </option>
        <option *ngFor="let note of notes" [ngValue]="note.id">{{ note.titre }}</option>
      </select>
    </div>

    <!-- Note actuelle -->
    <p *ngIf="modalMode==='deassign'">
      Note actuelle : <strong>{{ selectedNoteTitle }}</strong>
    </p>

    <!-- Boutons -->
    <div class="modal-actions">
      <button class="btn btn-primary" (click)="confirmNoteAction()">
        {{ modalMode === 'assign' ? 'Assigner' : 'Retirer' }}
      </button>

      <button class="btn btn-secondary" (click)="closeNoteModal()">Annuler</button>
    </div>

  </div>
</div>

<!-- Loader -->
<ng-template #loadingTpl>
  <div class="loading">Chargement...</div>
</ng-template>

<!-- Erreur -->
<div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>
