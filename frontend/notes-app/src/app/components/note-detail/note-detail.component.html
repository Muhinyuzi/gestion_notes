<app-toast #toast></app-toast>

<div *ngIf="isLoading" class="loading">â³ Chargement...</div>
<div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>

<div *ngIf="note" class="note-detail">

  <!-- Mode lecture -->
  <div *ngIf="!isEditing" class="view-mode">
    <h2 class="note-title">
      ğŸ“ {{ note.titre }}
      <span *ngIf="(note?.nb_vues || 0) > 100" class="badge-populaire">ğŸ”¥ Populaire</span>
      <span *ngIf="note?.created_at && isNew(note.created_at)" class="badge-nouveau">ğŸ†• Nouveau</span>
    </h2>

    <p class="note-content" [innerHTML]="note.contenu">{{ note.contenu }}</p>
    <p *ngIf="note.resume_ia" [innerHTML]="note.resume_ia"><strong>ğŸ§  RÃ©sumÃ© :</strong> {{ note.resume_ia }}</p>

    <!-- Fichiers existants -->
    <div class="note-images" *ngIf="note.fichiers?.length">
      <h4>ğŸ“ Fichiers / Images :</h4>
      <ul>
        <li *ngFor="let fichier of note.fichiers">
          <a [href]="getFileUrl(fichier.chemin)" download>{{ fichier.nom_fichier }}</a>
          <button *ngIf="canEditOrDelete(note)" type="button" class="remove-file-btn"
            (click)="removeExistingFile(fichier.id)">âŒ</button>
        </li>
      </ul>
    </div>

    <div class="meta">
      <p>ğŸ‘¥ <strong>Ã‰quipe :</strong> {{ note.equipe || 'â€”' }}</p>
      <p>âœï¸ <strong>Auteur :</strong> {{ note.auteur?.nom || 'Inconnu' }}</p>
      <p class="created">ğŸ“… <strong>CrÃ©Ã©e le :</strong> {{ note.created_at | date:'short' }}</p>
      <p *ngIf="note.updated_at" class="updated">âœï¸ <strong>ModifiÃ©e le :</strong> {{ note.updated_at | date:'short' }}</p>
      <p *ngIf="note.categorie"><strong>CatÃ©gorie :</strong> {{ note.categorie }}</p>
      <p *ngIf="note.priorite"><strong>PrioritÃ© :</strong> {{ note.priorite }}</p>
    </div>

    <div class="stats">
      <span>ğŸ‘ï¸ Vues : {{ note.nb_vues || 0 }}</span>
      <span>â¤ï¸ Likes : {{ note.likes || 0 }}
        <button (click)="likeNote()" [disabled]="hasLiked">ğŸ‘</button>
      </span>
    </div>

    <div class="actions" *ngIf="canEditOrDelete(note)">
      <button (click)="isEditing = true" class="edit-btn">âœï¸ Ã‰diter</button>
      <button (click)="deleteNote()" class="delete-btn">ğŸ—‘ï¸ Supprimer</button>
    </div>
  </div>

  <!-- Mode Ã©dition -->
  <div *ngIf="isEditing" class="edit-mode">
    <input [(ngModel)]="note.titre" placeholder="Titre" class="edit-input" />
    <!--<textarea [(ngModel)]="note.contenu" placeholder="Contenu" class="edit-textarea"></textarea>-->
    <kendo-editor [(ngModel)]="note.contenu" [resizable]="true" placeholder="Contenu"></kendo-editor>
    <!-- Ã‰quipe -->
    <input [(ngModel)]="note.equipe" placeholder="Ã‰quipe" [readonly]="currentUser?.type !== 'admin'" class="edit-input" />

    <!-- CatÃ©gorie -->
    <select [(ngModel)]="note.categorie" class="edit-select">
      <option value="" disabled selected>-- Choisir une catÃ©gorie --</option>
      <option value="Technique">Technique</option>
      <option value="RH">Ressources humaines</option>
      <option value="Administration">Administration</option>
      <option value="Autre">Autre</option>
    </select>

    <!-- PrioritÃ© -->
    <select [(ngModel)]="note.priorite" class="edit-select">
      <option value="" disabled selected>-- Choisir la prioritÃ© --</option>
      <option value="basse">Basse</option>
      <option value="moyenne">Moyenne</option>
      <option value="haute">Haute</option>
    </select>

    <!-- Upload fichiers -->
    <input type="file" #fileInput (change)="handleFileInput($event)" multiple class="edit-input">

    <!-- Liste fichiers ajoutÃ©s -->
    <div *ngIf="newFiles.length > 0" class="selected-files">
      <p>ğŸ“ Nouveaux fichiers :</p>
      <ul>
        <li *ngFor="let f of newFiles; let i = index">
          {{ f.name }}
          <button type="button" class="remove-file-btn" (click)="removeFile(i)">âŒ</button>
        </li>
      </ul>
    </div>

    <div class="actions">
      <button (click)="updateNote()" class="save-btn">ğŸ’¾ Sauvegarder</button>
      <button (click)="isEditing = false" class="cancel-btn">âŒ Annuler</button>
    </div>
  </div>

  <hr>
  <app-commentaires [noteId]="note.id"></app-commentaires>
</div>
